#!/bin/bash

# Output file
OUTPUT_FILE="anonymous_access_results.txt"

# Function to check SMB guest connection
check_smb_guest() {
  smbclient -L "\\\\$1" -N -g 2>/dev/null | grep -q "IPC\$"
  if [ $? -eq 0 ]; then
    echo "SMB Guest access available on $1"
    echo "SMB Guest access available on $1" >> "$OUTPUT_FILE"
    return 0
  fi
  return 1
}

# Function to check RPC anonymous connection
check_rpc_anonymous() {
  rpcclient -U "" "$1" -N -c "srvinfo" 2>/dev/null > /dev/null
  if [ $? -eq 0 ]; then
    echo "RPC Anonymous access available on $1"
    echo "RPC Anonymous access available on $1" >> "$OUTPUT_FILE"
    return 0
  fi
  return 1
}

# Function to check FTP anonymous connection
check_ftp_anonymous() {
  echo "quit" | ftp -inv "$1" 2>/dev/null | grep -q "230"
  if [ $? -eq 0 ]; then
    echo "FTP Anonymous access available on $1"
    echo "FTP Anonymous access available on $1" >> "$OUTPUT_FILE"
    return 0
  fi
  return 1
}

# Main script
if [ $# -ne 1 ]; then
  echo "Usage: $0 <file_with_ips>"
  exit 1
fi

if [ ! -f "$1" ]; then
  echo "File not found: $1"
  exit 1
fi

# Clear the output file
> "$OUTPUT_FILE"

# Variable to track if any anonymous connections were found
found_anonymous=false

while IFS= read -r ip; do
  check_smb_guest "$ip" && found_anonymous=true
  check_rpc_anonymous "$ip" && found_anonymous=true
  check_ftp_anonymous "$ip" && found_anonymous=true
done < "$1"

if [ "$found_anonymous" = false ]; then
  rm "$OUTPUT_FILE"
  echo -e "\e[31mNO ANONYMOUS CONNECTIONS\e[0m"
fi
